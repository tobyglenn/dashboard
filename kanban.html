<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="navbar">
        <a href="/">Dashboard</a>
        <span>‚Ä¢</span>
        <a href="/kanban" class="active">Kanban Board</a>
        <span>‚Ä¢</span>
        <a href="/fitness">Fitness Reports</a>
    </nav>

    <div class="container">
        <h1>üìã Kanban Board</h1>

        <div class="kanban-board">
            <div class="kanban-column approve-column">
                <h2>üîç To Approve</h2>
                <div id="approve-tasks"></div>
            </div>
            <div class="kanban-column">
                <h2>To Do</h2>
                <div id="todo-tasks"></div>
            </div>
            <div class="kanban-column">
                <h2>In Progress</h2>
                <div id="inprogress-tasks"></div>
            </div>
            <div class="kanban-column">
                <h2>Review</h2>
                <div id="review-tasks"></div>
            </div>
            <div class="kanban-column">
                <h2>Done</h2>
                <div id="done-tasks"></div>
            </div>
        </div>
    </div>

    <script>
        const statusMap = {
            'To Approve': 'approve-tasks',
            'To Do': 'todo-tasks',
            'In Progress': 'inprogress-tasks',
            'Review': 'review-tasks',
            'Done': 'done-tasks'
        };

        async function reassignTask(taskId, newAssignee) {
            try {
                const resp = await fetch('/api/reassign', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId, assignee: newAssignee})
                });
                if (resp.ok) loadKanban();
            } catch(e) { console.error('Reassign failed:', e); }
        }

        async function completeTask(taskId) {
            try {
                const resp = await fetch('/api/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId})
                });
                if (resp.ok) loadKanban();
            } catch(e) { console.error('Complete failed:', e); }
        }

        async function saveNotes(taskId, notes) {
            try {
                const resp = await fetch('/api/notes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId, notes: notes})
                });
                if (!resp.ok) console.error('Save notes failed');
            } catch(e) { console.error('Save notes failed:', e); }
        }

        async function rejectTask(taskId) {
            try {
                const btn = document.querySelector(`.reject-btn[onclick*="${taskId}"]`);
                const card = btn ? btn.closest('.kanban-card') : null;
                const textarea = card ? card.querySelector('.task-notes-area') : null;
                const notes = textarea ? textarea.value : '';
                const resp = await fetch('/api/reject', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId, notes: notes})
                });
                if (resp.ok) loadKanban();
            } catch(e) { console.error('Reject failed:', e); }
        }

        async function approveTask(taskId) {
            try {
                const card = document.querySelector(`[onclick="approveTask('${taskId}')"]`).closest('.kanban-card');
                const sel = card ? card.querySelector('.assignee-select') : null;
                const assignee = sel ? sel.value : '';
                const resp = await fetch('/api/approve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId, assignee: assignee})
                });
                if (resp.ok) loadKanban();
            } catch(e) { console.error('Approve failed:', e); }
        }

        async function loadKanban() {
            try {
                const resp = await fetch('/data/kanban.json?t=' + Date.now());
                const data = await resp.json();
                Object.values(statusMap).forEach(id => document.getElementById(id).innerHTML = '');

                data.tasks.forEach(task => {
                    const col = document.getElementById(statusMap[task.status]);
                    if (!col) return;
                    const el = document.createElement('div');
                    el.className = 'kanban-task';

                    if (task.status === 'To Approve') {
                        const detailLink = task.detail_file
                            ? `<a href="/task-details/${task.id}.md" class="task-detail-link" target="_blank">View Details ‚Üí</a>`
                            : '';
                        const agents = ['ARIA', 'Clawd', 'BOB', 'Clarity', 'Sage', 'Spark', 'Vision', 'Pulse'];
                        const options = agents.map(a =>
                            `<option value="${a}"${a === task.assignee ? ' selected' : ''}>${a}</option>`
                        ).join('');
                        const assigneeSelect = `<p class="approve-assignee">üìå Will assign ‚Üí
                            <select class="assignee-select" onchange="reassignTask('${task.id}', this.value)">
                                <option value="">Select...</option>
                                ${options}
                            </select></p>`;
                        const notesVal = (task.notes || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
                        const notesField = `<div class="task-notes">
                            <textarea class="notes-input" placeholder="Add notes or requirements..."
                                onblur="saveNotes('${task.id}', this.value)"
                                rows="3">${task.notes || ''}</textarea>
                        </div>`;
                        el.innerHTML = `
                            <div class="approve-row">
                                <input type="checkbox" class="approve-check" title="Approve ‚Üí To Do" onclick="approveTask('${task.id}')">
                                <div class="approve-content">
                                    <h3>${task.title}</h3>
                                    <p>${task.description}</p>
                                    ${notesField}
                                    ${assigneeSelect}
                                    ${detailLink}
                                </div>
                            </div>`;
                    } else if (task.status === 'Review') {
                        const previewUrl = task.preview_url || 'http://localhost:8082/';
                        const reviewNotes = (task.notes || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
                        el.innerHTML = `
                            <div class="approve-row">
                                <input type="checkbox" class="approve-check" title="Mark as Done ‚úÖ" onclick="completeTask('${task.id}')">
                                <div class="approve-content">
                                    <h3>${task.title}</h3>
                                    <p>${task.description}</p>
                                    <p><strong>Assignee:</strong> ${task.assignee || 'Unassigned'}</p>
                                    <a href="${previewUrl}" target="_blank" class="task-preview-link">Preview ‚Üí</a>
                                    <div class="task-notes">
                                        <textarea class="task-notes-area" placeholder="Review notes / feedback..."
                                            onblur="saveNotes('${task.id}', this.value)"
                                            rows="3">${task.notes || ''}</textarea>
                                    </div>
                                    <button class="reject-btn" onclick="rejectTask('${task.id}')">‚ùå Reject ‚Üí To Do</button>
                                </div>
                            </div>`;
                    } else {
                        const notesHtml = task.notes ? `<div class="task-rejection-notes">üìù <em>${task.notes.replace(/</g, '&lt;')}</em></div>` : '';
                        el.innerHTML = `<h3>${task.title}</h3><p>${task.description}</p><p><strong>Assignee:</strong> ${task.assignee || 'Unassigned'}</p>${task.due_date ? '<p><strong>Due:</strong> ' + task.due_date + '</p>' : ''}${notesHtml}`;
                    }
                    col.appendChild(el);
                });
            } catch(e) { console.error('Error loading kanban:', e); }
        }

        loadKanban();
        setInterval(loadKanban, 15000);
    </script>
</body>
</html>
