<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="active">Dashboard</a>
        <span>‚Ä¢</span>
        <a href="/kanban">Kanban Board</a>
        <span>‚Ä¢</span>
        <a href="/fitness">Fitness Reports</a>
    </nav>

    <header class="header">
        <div class="logo">üå∏ OpenClaw Dashboard</div>
        <div class="system-status">‚óè System Online</div>
    </header>

    <div class="dashboard-container">
        <aside class="top-agents-desktop" id="top-agents"></aside>
        <div class="top-agents-mobile"><div class="mobile-grid" id="top-agents-mobile"></div></div>
        <div class="main-content"><div class="grid" id="subagents-grid"></div></div>
        <aside class="activity-panel">
            <h3>Activity Log</h3>
            <div class="activity-log" id="activity-log"></div>
        </aside>
    </div>

    <script>
    const TOP_NAMES = ['ARIA', 'Clawd', 'BOB'];

    function renderCard(a) {
        const isActive = (a.status || '').toLowerCase() === 'active';
        const icon = a.icon || a.emoji || 'ü§ñ';
        return `<div class="card${isActive ? ' active' : ''}">
            <div class="card-header">
                <span class="icon">${icon}</span>
                <span class="name">${a.name || ''}</span>
            </div>
            <div class="role">${a.role || ''}</div>
            <span class="status-badge status-${(a.status||'offline').toLowerCase()}">${a.status || 'offline'}</span>
            <p class="description">${a.description || a.current_task || ''}</p>
        </div>`;
    }

    function renderActivity(items) {
        return items.map(i => {
            const time = i.time || i.timestamp || '';
            const text = i.text || i.title || i.description || '';
            const agent = i.agent || i.assignee || '';
            return `<div class="activity-item"><span class="time">${time}</span> <strong>${agent}</strong> ${text}</div>`;
        }).join('');
    }

    async function refresh() {
        try {
            const [dResp, kResp] = await Promise.all([
                fetch('/dashboard.json?t=' + Date.now()),
                fetch('/data/kanban.json?t=' + Date.now())
            ]);
            const dash = await dResp.json();
            const kanban = await kResp.json().catch(() => ({}));

            const agents = dash.agents || [];
            const top = agents.filter(a => TOP_NAMES.includes(a.name));
            const sub = agents.filter(a => !TOP_NAMES.includes(a.name));

            document.getElementById('top-agents').innerHTML = top.map(renderCard).join('');
            document.getElementById('top-agents-mobile').innerHTML = top.map(renderCard).join('');
            document.getElementById('subagents-grid').innerHTML = sub.map(renderCard).join('');

            // Activity: combine dashboard activities + kanban tasks (exclude Done/To Approve)
            const dashAct = (dash.activities || dash.activity_log || []);
            const excluded = ['done', 'to approve'];
            const kanbanTasks = (kanban.tasks || kanban.columns || [])
                .flat()
                .filter(t => t && !excluded.includes((t.status||'').toLowerCase()))
                .map(t => ({time: t.updated || t.created || '', agent: t.assignee || '', text: t.title || t.description || '', _ts: t.updated || t.created || ''}));
            const combined = [...dashAct.map(a => ({...a, _ts: a.time || a.timestamp || ''})), ...kanbanTasks]
                .sort((a,b) => (b._ts||'').localeCompare(a._ts||''));
            document.getElementById('activity-log').innerHTML = renderActivity(combined);
        } catch(e) { console.error('Dashboard refresh error', e); }
    }

    refresh();
    setInterval(refresh, 15000);
    </script>
</body>
</html>
