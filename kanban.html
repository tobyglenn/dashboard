<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="navbar">
        <a href="/">Dashboard</a>
        <span>‚Ä¢</span>
        <a href="/kanban" class="active">Kanban Board</a>
        <span>‚Ä¢</span>
        <a href="/backlog">Backlog</a>
        <span>‚Ä¢</span>
        <a href="/fitness">Fitness Reports</a>
    </nav>

    <div class="container">
        <h1>üìã Kanban Board</h1>

        <div class="epic-filter">
            <label for="epic-filter">Filter by Epic:</label>
            <select id="epic-filter" onchange="loadKanban()">
                <option value="all">All Epics</option>
            </select>
        </div>

        <div class="add-task-form">
            <textarea id="new-task-desc" placeholder="Description"></textarea>
            <select id="new-task-status">
                <option value="To Approve">To Approve</option>
                <option value="To Do">To Do</option>
            </select>
            <input type="text" id="new-task-epic" placeholder="Epic (optional)">
            <select id="new-task-assignee">
                <option value="">Assignee...</option>
                <option>üå∏ ARIA</option><option>ü§ñ Clawd</option><option>üîß BOB</option>
                <option>üîç Clarity</option><option>üß† Sage</option><option>‚ö° Spark</option>
                <option>üëÅÔ∏è Vision</option><option>üåä Pulse</option>
            </select>
            <input type="text" id="new-task-due-date" placeholder="ETA (e.g. ~30 min, ~2 hours)">
            <button class="add-task-btn" onclick="addTask()">‚ûï Add Task</button>
        </div>

        <div class="kanban-board">
            <div class="kanban-column approve-column">
                <h2>üîç To Approve</h2>
                <div id="approve-tasks"></div>
            </div>
            <div class="kanban-column">
                <h2>To Do</h2>
                <div id="todo-tasks"></div>
            </div>
            <div class="kanban-column">
                <h2>In Progress</h2>
                <div id="inprogress-tasks"></div>
            </div>
            <div class="kanban-column">
                <h2>Review</h2>
                <div id="review-tasks"></div>
            </div>
            <div class="kanban-column">
                <h2>Done</h2>
                <div id="done-tasks"></div>
            </div>
        </div>
    </div>

    <script>
        const statusMap = {
            'To Approve': 'approve-tasks',
            'To Do': 'todo-tasks',
            'In Progress': 'inprogress-tasks',
            'Review': 'review-tasks',
            'Done': 'done-tasks'
        };

        async function reassignTask(taskId, newAssignee) {
            try {
                const resp = await fetch('/api/reassign', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId, assignee: newAssignee})
                });
                if (resp.ok) loadKanban();
            } catch(e) { console.error('Reassign failed:', e); }
        }

        async function completeTask(taskId) {
            try {
                const resp = await fetch('/api/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId})
                });
                if (resp.ok) loadKanban();
            } catch(e) { console.error('Complete failed:', e); }
        }

        async function saveNotes(taskId, notes) {
            try {
                const resp = await fetch('/api/notes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId, notes: notes})
                });
                if (!resp.ok) console.error('Save notes failed');
            } catch(e) { console.error('Save notes failed:', e); }
        }

        async function rejectTask(taskId) {
            try {
                const btn = document.querySelector(`.reject-btn[onclick*="${taskId}"]`);
                const card = btn ? btn.closest('.kanban-task') : null;
                const textarea = card ? card.querySelector('.task-notes-area') : null;
                const notes = textarea ? textarea.value : '';
                const resp = await fetch('/api/reject', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId, notes: notes})
                });
                if (resp.ok) loadKanban();
            } catch(e) { console.error('Reject failed:', e); }
        }

        async function addTask() {
            const description = document.getElementById('new-task-desc').value.trim();
            if (!description) return alert('Description is required');
            const status = document.getElementById('new-task-status').value;
            const assignee = document.getElementById('new-task-assignee').value;
            const epic = document.getElementById('new-task-epic').value.trim();
            const due_date = document.getElementById('new-task-due-date').value.trim();
            
            // Generate title based on status
            let title = '';
            if (status === 'To Do') {
                title = description.substring(0, 50) + (description.length > 50 ? '...' : '');
            } else if (status === 'To Approve') {
                title = '(to generate)';
            }
            
            // Look up epic color if epic exists
            let taskEpicColor = '';
            if (epic && epicColors[epic]) {
                taskEpicColor = epicColors[epic];
            }
            
            try {
                const resp = await fetch('/api/add-task', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title, description, status, assignee, epic, due_date, epic_color: taskEpicColor || undefined})
                });
                if (resp.ok) {
                    document.getElementById('new-task-desc').value = '';
                    document.getElementById('new-task-epic').value = '';
                    loadKanban();
                }
            } catch(e) { console.error('Add task failed:', e); }
        }

        async function approveTask(taskId) {
            try {
                const card = document.querySelector(`[onclick="approveTask('${taskId}')"]`).closest('.kanban-card');
                const sel = card ? card.querySelector('.assignee-select') : null;
                const assignee = sel ? sel.value : '';
                const resp = await fetch('/api/approve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId, assignee: assignee})
                });
                if (resp.ok) loadKanban();
            } catch(e) { console.error('Approve failed:', e); }
        }

        async function backlogTask(taskId) {
            try {
                const resp = await fetch('/api/backlog', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: taskId})
                });
                if (resp.ok) loadKanban();
            } catch(e) { console.error('Backlog failed:', e); }
        }

        // Global epic color mapping
        let epicColors = {};

        async function loadKanban() {
            try {
                const resp = await fetch('/data/kanban.json?t=' + Date.now());
                const data = await resp.json();
                Object.values(statusMap).forEach(id => document.getElementById(id).innerHTML = '');

                // Collect all unique epic names from data.tasks
                const epics = [...new Set(data.tasks.map(t => t.epic).filter(Boolean))].sort();

                // Build epic ‚Üí color mapping from tasks
                epicColors = {};
                data.tasks.forEach(task => {
                    if (task.epic && task.epic_color) {
                        epicColors[task.epic] = task.epic_color;
                    }
                });

                // Get the epic-filter select element and remember its current value
                const epicFilter = document.getElementById('epic-filter');
                const previousValue = epicFilter.value;

                // Rebuild its options: first "All Epics" with value="all", then one option per epic
                epicFilter.innerHTML = '<option value="all">All Epics</option>';
                epics.forEach(epic => {
                    const option = document.createElement('option');
                    option.value = epic;
                    option.textContent = epic;
                    epicFilter.appendChild(option);
                });

                // Restore the previously selected value if it still exists
                if (epics.includes(previousValue)) {
                    epicFilter.value = previousValue;
                }

                // Sort Done tasks to bottom (append order) by keeping original array order
                // but for Done column, reverse so newest appears at bottom
                const doneTasks = data.tasks.filter(t => t.status === 'Done').reverse();
                const otherTasks = data.tasks.filter(t => t.status !== 'Done');
                const orderedTasks = [...otherTasks, ...doneTasks];

                // Filter tasks based on selected epic (if any)
                const selectedEpic = document.getElementById('epic-filter').value;
                let filteredTasks = orderedTasks;
                if (selectedEpic !== 'all') {
                    filteredTasks = orderedTasks.filter(task => 
                        task.epic === selectedEpic
                    );
                }

                filteredTasks.forEach(task => {
                    const col = document.getElementById(statusMap[task.status]);
                    if (!col) return;
                    const el = document.createElement('div');
                    el.className = 'kanban-task';

                    // Add epic border if task has epic
                    if (task.epic && task.epic_color) {
                        el.style.borderLeft = `4px solid ${task.epic_color}`;
                    }

                    if (task.status === 'To Approve') {
                        const detailLink = task.detail_file
                            ? `<a href="/task-details/${task.id}.md" class="task-detail-link" target="_blank">View Details ‚Üí</a>`
                            : '';
                        const agents = ['üå∏ ARIA', 'ü§ñ Clawd', 'üîß BOB', 'üîç Clarity', 'üß† Sage', '‚ö° Spark', 'üëÅÔ∏è Vision', 'üåä Pulse'];
                        const options = agents.map(a =>
                            `<option value="${a}"${a === task.assignee ? ' selected' : ''}>${a}</option>`
                        ).join('');
                        const assigneeSelect = `<p class="approve-assignee">üìå Will assign ‚Üí
                            <select class="assignee-select" onchange="reassignTask('${task.id}', this.value)">
                                <option value="">Select...</option>
                                ${options}
                            </select></p>`;
                        const notesVal = (task.notes || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
                        const notesField = `<div class="task-notes">
                            <textarea class="notes-input" placeholder="Add notes or requirements..."
                                onblur="saveNotes('${task.id}', this.value)"
                                rows="3">${task.notes || ''}</textarea>
                        </div>`;
                        el.innerHTML = `
                            <div class="approve-row">
                                <input type="checkbox" class="approve-check" title="Approve ‚Üí To Do" onclick="approveTask('${task.id}')">
                                <div class="approve-content">
                                    <h3>${task.title}</h3>
                                    ${task.epic ? `<span class="epic-tag" style="border-color: ${task.epic_color}; color: ${task.epic_color}">${task.epic}</span>` : ''}
                                    <p>${task.description}</p>
                                    ${notesField}
                                    ${assigneeSelect}
                                    ${detailLink}
                                    <button class="backlog-btn" onclick="backlogTask('${task.id}')">üì¶ Backlog</button>
                                </div>
                            </div>`;
                    } else if (task.status === 'Review') {
                        const previewUrl = task.preview_url || 'http://localhost:8082/';
                        el.innerHTML = `
                            <div class="approve-row">
                                <div class="approve-content">
                                    <h3>${task.title}</h3>
                                    ${task.epic ? `<span class="epic-tag" style="border-color: ${task.epic_color}; color: ${task.epic_color}">${task.epic}</span>` : ''}
                                    <p>${task.description}</p>
                                    <p><strong>Assignee:</strong> ${task.assignee || 'Unassigned'}</p>
                                    <a href="${previewUrl}" target="_blank" class="task-preview-link">Preview ‚Üí</a>
                                    <textarea class="task-notes-area" placeholder="Review notes / feedback..."
                                        onblur="saveNotes('${task.id}', this.value)"
                                        rows="3">${task.notes || ''}</textarea>
                                    <button class="approve-btn" onclick="completeTask('${task.id}')">‚úÖ Approve</button>
                                    <button class="reject-btn" onclick="rejectTask('${task.id}')">‚ùå Reject ‚Üí To Do</button>
                                </div>
                            </div>`;
                    } else {
                        const notesHtml = task.notes ? `<div class="task-rejection-notes">üìù <em>${task.notes.replace(/</g, '&lt;')}</em></div>` : '';
                        el.innerHTML = `
                            <div class="approve-row">
                                <div class="approve-content">
                                    <h3>${task.title}</h3>
                                    ${task.epic ? `<span class="epic-tag" style="border-color: ${task.epic_color}; color: ${task.epic_color}">${task.epic}</span>` : ''}
                                    <p>${task.description}</p>
                                    <p><strong>Assignee:</strong> ${task.assignee || 'Unassigned'}</p>
                                    <p><strong>ETA:</strong> ${task.due_date ? '‚è±Ô∏è ' + task.due_date : ''}</p>
                                    ${notesHtml}
                                </div>
                            </div>`;
                    }
                    col.appendChild(el);
                });
            } catch(e) { console.error('Error loading kanban:', e); }
        }

        loadKanban();
        setInterval(() => {
            if (!document.activeElement || !['TEXTAREA','INPUT','SELECT'].includes(document.activeElement.tagName)) {
                loadKanban();
            }
        }, 15000);
    </script>
</body>
</html>